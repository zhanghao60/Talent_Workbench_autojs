<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Django WebSocket 测试</title>
</head>
<body>
    <h3>WebSocket 连接状态：<span id="connStatus">未连接</span></h3>
    <p>服务端连接状态：<span id="serverStatus"></span></p>
    <p>服务端返回内容：<span id="serverMsg"></span></p>
    <p>错误信息：<span id="errorMsg"></span></p>
    <button id="sendBtn" onclick="sendMessage()">发送消息</button>
    <script>
        // 1. 替换为你的 Django WebSocket 服务地址（服务器IP需替换，本地用127.0.0.1）
        const wsUrl = 'ws://127.0.0.1:8000/ws/target/456456/';
        // 2. 创建 WebSocket 实例
        const ws = new WebSocket(wsUrl);

        // 3. 连接成功时触发（核心：返回并显示“连接成功”）
        ws.onopen = function() {
            const connStatus = document.getElementById('connStatus');
            const serverMsg = document.getElementById('serverStatus');
            // 页面显示“连接成功”
            connStatus.textContent = '已连接';
            connStatus.style.color = 'green';
            serverMsg.textContent = '连接成功';
            // 可选：向服务端发送“连接成功”的确认消息
            ws.send(JSON.stringify({ 'message': '客户端已连接' }));
            console.log('WebSocket 连接成功');
        };

        // 4. 接收服务端消息（显示服务端回复）
        ws.onmessage = function(event) {
            const serverMsg = document.getElementById('serverMsg');
            const data = JSON.parse(event.data);
            serverMsg.textContent = data.server_message; // 显示服务端返回的内容
        };

        // 5. 连接失败/断开时提示
        ws.onclose = function() {
            const connStatus = document.getElementById('connStatus');
            connStatus.textContent = '已断开';
            connStatus.style.color = 'red';
            console.log('WebSocket 连接断开');
        };

        // 6. 捕获连接错误
        ws.onerror = function(error) {
            console.error('WebSocket 连接错误：', error);
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = '连接失败';
        };

        function sendMessage() {
            data = {
                "message": "这是http请求发送的消息",
                "是否执行脚本": true,
                "脚本路径": "/sdcard/trmkt/script.js",
            }
            data = JSON.stringify(data);
            fetch('http://127.0.0.1:8000/consumers/forward/456456/', {
                method: 'POST',
                body: data,
            }).then(
                    response => response.json()
                ).then(data => {
                    console.log(data);
                }).catch(error => {
                    console.error('发送消息失败：', error);
                });
        }
    </script>
</body>
</html>